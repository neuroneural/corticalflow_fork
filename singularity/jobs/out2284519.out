[2023-03-10 18:30:54,983][__main__][INFO] - Predicting surfaces with Cortical Flow
Config:
user_config: null
inputs:
  data_type: formatted
  path: /subj/
  split_name: test
  split_file: /corticalflow/subjs.csv
  hemisphere: lh
  device: cuda:0
  template: /corticalflow/resources/smooth_templates/lh_white_smooth_380k.obj
white_model:
  nb_features:
  - - - 16
      - 32
      - 32
      - 32
    - - 32
      - 32
      - 32
      - 32
      - 32
      - 16
      - 16
  - - - 16
      - 32
    - - 32
      - 32
      - 16
      - 16
  - - - 16
      - 32
    - - 32
      - 32
      - 16
      - 16
  integration_method: RK4
  integration_steps: 30
  share_flows: true
  model_checkpoint: /corticalflow/resources/trained_models/CFPP_LEFT_WHITE.pth
pial_model:
  nb_features:
  - - - 16
      - 32
    - - 32
      - 32
      - 16
      - 16
  - - - 16
      - 32
    - - 32
      - 32
      - 16
      - 16
  - - - 16
      - 32
    - - 32
      - 32
      - 16
      - 16
  integration_method: RK4
  integration_steps: 30
  share_flows: true
  model_checkpoint: /corticalflow/resources/trained_models/CFPP_LEFT_PIAL.pth
outputs:
  output_dir: /data/users2/washbee/corticalflow/cfpp/output_lh/
  out_deform:
  - 0
  - 1
  - 2
  out_format: freesurfer

[2023-03-10 18:30:54,984][__main__][INFO] - loading from formatted dataset...
[2023-03-10 18:30:54,989][__main__][INFO] - 1 subjects loaded for test in 0.0046 secs
[2023-03-10 18:30:57,439][__main__][INFO] - Template mesh <trimesh.Trimesh(vertices.shape=(379970, 3), faces.shape=(759936, 3))> read from /corticalflow/resources/smooth_templates/lh_white_smooth_380k.obj

*********empty cache, before loading white model() 
 
Device 0: Tesla V100-SXM2-32GB, Memory : (99.20% free): 34359738368(total), 34085994496 (free), 273743872 (used)
Max Memory occupied by tensors: 0
Max Memory Cached: 0
Current Memory occupied by tensors: 0
Current Memory cached occupied by tensors: 0


*********after loading white model() 
 
Device 0: Tesla V100-SXM2-32GB, Memory : (96.10% free): 34359738368(total), 33019592704 (free), 1340145664 (used)
Max Memory occupied by tensors: 2093056
Max Memory Cached: 2097152
Current Memory occupied by tensors: 2093056
Current Memory cached occupied by tensors: 2097152

[2023-03-10 18:30:59,661][__main__][INFO] - 2.2191 secs for white model setup:
CorticalFlow(
  (deform_blocks): ModuleList(
    (0): DeformationBlock(
      (encoder): Unet(
        (downarm): ModuleList(
          (0): ConvBlock(
            (main): Conv3d(1, 16, kernel_size=(3, 3, 3), stride=(2, 2, 2), padding=(1, 1, 1))
            (activation): LeakyReLU(negative_slope=0.2)
          )
          (1): ConvBlock(
            (main): Conv3d(16, 32, kernel_size=(3, 3, 3), stride=(2, 2, 2), padding=(1, 1, 1))
            (activation): LeakyReLU(negative_slope=0.2)
          )
          (2): ConvBlock(
            (main): Conv3d(32, 32, kernel_size=(3, 3, 3), stride=(2, 2, 2), padding=(1, 1, 1))
            (activation): LeakyReLU(negative_slope=0.2)
          )
          (3): ConvBlock(
            (main): Conv3d(32, 32, kernel_size=(3, 3, 3), stride=(2, 2, 2), padding=(1, 1, 1))
            (activation): LeakyReLU(negative_slope=0.2)
          )
        )
        (uparm): ModuleList(
          (0): Sequential(
            (0): ConvBlock(
              (main): Conv3d(32, 32, kernel_size=(3, 3, 3), stride=(1, 1, 1), padding=(1, 1, 1))
              (activation): LeakyReLU(negative_slope=0.2)
            )
            (1): Upsample(scale_factor=2.0, mode=nearest)
          )
          (1): Sequential(
            (0): ConvBlock(
              (main): Conv3d(64, 32, kernel_size=(3, 3, 3), stride=(1, 1, 1), padding=(1, 1, 1))
              (activation): LeakyReLU(negative_slope=0.2)
            )
            (1): Upsample(scale_factor=2.0, mode=nearest)
          )
          (2): Sequential(
            (0): ConvBlock(
              (main): Conv3d(64, 32, kernel_size=(3, 3, 3), stride=(1, 1, 1), padding=(1, 1, 1))
              (activation): LeakyReLU(negative_slope=0.2)
            )
            (1): Upsample(scale_factor=2.0, mode=nearest)
          )
          (3): Sequential(
            (0): ConvBlock(
              (main): Conv3d(48, 32, kernel_size=(3, 3, 3), stride=(1, 1, 1), padding=(1, 1, 1))
              (activation): LeakyReLU(negative_slope=0.2)
            )
            (1): Upsample(scale_factor=2.0, mode=nearest)
          )
        )
        (extras): ModuleList(
          (0): ConvBlock(
            (main): Conv3d(33, 32, kernel_size=(3, 3, 3), stride=(1, 1, 1), padding=(1, 1, 1))
            (activation): LeakyReLU(negative_slope=0.2)
          )
          (1): ConvBlock(
            (main): Conv3d(32, 16, kernel_size=(3, 3, 3), stride=(1, 1, 1), padding=(1, 1, 1))
            (activation): LeakyReLU(negative_slope=0.2)
          )
          (2): ConvBlock(
            (main): Conv3d(16, 16, kernel_size=(3, 3, 3), stride=(1, 1, 1), padding=(1, 1, 1))
            (activation): LeakyReLU(negative_slope=0.2)
          )
        )
      )
      (flow): Conv3d(16, 3, kernel_size=(3, 3, 3), stride=(1, 1, 1), padding=(1, 1, 1))
      (deformer): DiffeoMeshDeformer(
        (integrate): IntegratePointWiseRK4(
          (interpolator): PointPooling()
        )
      )
    )
    (1): DeformationBlock(
      (encoder): Unet(
        (downarm): ModuleList(
          (0): ConvBlock(
            (main): Conv3d(4, 16, kernel_size=(3, 3, 3), stride=(2, 2, 2), padding=(1, 1, 1))
            (activation): LeakyReLU(negative_slope=0.2)
          )
          (1): ConvBlock(
            (main): Conv3d(16, 32, kernel_size=(3, 3, 3), stride=(2, 2, 2), padding=(1, 1, 1))
            (activation): LeakyReLU(negative_slope=0.2)
          )
        )
        (uparm): ModuleList(
          (0): Sequential(
            (0): ConvBlock(
              (main): Conv3d(32, 32, kernel_size=(3, 3, 3), stride=(1, 1, 1), padding=(1, 1, 1))
              (activation): LeakyReLU(negative_slope=0.2)
            )
            (1): Upsample(scale_factor=2.0, mode=nearest)
          )
          (1): Sequential(
            (0): ConvBlock(
              (main): Conv3d(48, 32, kernel_size=(3, 3, 3), stride=(1, 1, 1), padding=(1, 1, 1))
              (activation): LeakyReLU(negative_slope=0.2)
            )
            (1): Upsample(scale_factor=2.0, mode=nearest)
          )
        )
        (extras): ModuleList(
          (0): ConvBlock(
            (main): Conv3d(36, 16, kernel_size=(3, 3, 3), stride=(1, 1, 1), padding=(1, 1, 1))
            (activation): LeakyReLU(negative_slope=0.2)
          )
          (1): ConvBlock(
            (main): Conv3d(16, 16, kernel_size=(3, 3, 3), stride=(1, 1, 1), padding=(1, 1, 1))
            (activation): LeakyReLU(negative_slope=0.2)
          )
        )
      )
      (flow): Conv3d(16, 3, kernel_size=(3, 3, 3), stride=(1, 1, 1), padding=(1, 1, 1))
      (deformer): DiffeoMeshDeformer(
        (integrate): IntegratePointWiseRK4(
          (interpolator): PointPooling()
        )
      )
    )
    (2): DeformationBlock(
      (encoder): Unet(
        (downarm): ModuleList(
          (0): ConvBlock(
            (main): Conv3d(7, 16, kernel_size=(3, 3, 3), stride=(2, 2, 2), padding=(1, 1, 1))
            (activation): LeakyReLU(negative_slope=0.2)
          )
          (1): ConvBlock(
            (main): Conv3d(16, 32, kernel_size=(3, 3, 3), stride=(2, 2, 2), padding=(1, 1, 1))
            (activation): LeakyReLU(negative_slope=0.2)
          )
        )
        (uparm): ModuleList(
          (0): Sequential(
            (0): ConvBlock(
              (main): Conv3d(32, 32, kernel_size=(3, 3, 3), stride=(1, 1, 1), padding=(1, 1, 1))
              (activation): LeakyReLU(negative_slope=0.2)
            )
            (1): Upsample(scale_factor=2.0, mode=nearest)
          )
          (1): Sequential(
            (0): ConvBlock(
              (main): Conv3d(48, 32, kernel_size=(3, 3, 3), stride=(1, 1, 1), padding=(1, 1, 1))
              (activation): LeakyReLU(negative_slope=0.2)
            )
            (1): Upsample(scale_factor=2.0, mode=nearest)
          )
        )
        (extras): ModuleList(
          (0): ConvBlock(
            (main): Conv3d(39, 16, kernel_size=(3, 3, 3), stride=(1, 1, 1), padding=(1, 1, 1))
            (activation): LeakyReLU(negative_slope=0.2)
          )
          (1): ConvBlock(
            (main): Conv3d(16, 16, kernel_size=(3, 3, 3), stride=(1, 1, 1), padding=(1, 1, 1))
            (activation): LeakyReLU(negative_slope=0.2)
          )
        )
      )
      (flow): Conv3d(16, 3, kernel_size=(3, 3, 3), stride=(1, 1, 1), padding=(1, 1, 1))
      (deformer): DiffeoMeshDeformer(
        (integrate): IntegratePointWiseRK4(
          (interpolator): PointPooling()
        )
      )
    )
  )
)
[2023-03-10 18:30:59,662][__main__][INFO] - White model Total number of parameters: 519865
[2023-03-10 18:30:59,679][__main__][INFO] - White Model weights at deformation train 2 iteration 65000 and validation metric 0.0000 loaded from /corticalflow/resources/trained_models/CFPP_LEFT_WHITE.pth in 0.0166 secs
white model size





model size: 1.983MB






*********empty cache, before loading pial model() 
 
Device 0: Tesla V100-SXM2-32GB, Memory : (96.10% free): 34359738368(total), 33019592704 (free), 1340145664 (used)
Max Memory occupied by tensors: 5083136
Max Memory Cached: 6291456
Current Memory occupied by tensors: 2093056
Current Memory cached occupied by tensors: 2097152


*********after loading pial model() 
 
Device 0: Tesla V100-SXM2-32GB, Memory : (96.09% free): 34359738368(total), 33017495552 (free), 1342242816 (used)
Max Memory occupied by tensors: 5083136
Max Memory Cached: 6291456
Current Memory occupied by tensors: 3407872
Current Memory cached occupied by tensors: 4194304

[2023-03-10 18:30:59,695][__main__][INFO] - 0.0135 secs for white model setup:
CorticalFlow(
  (deform_blocks): ModuleList(
    (0): DeformationBlock(
      (encoder): Unet(
        (downarm): ModuleList(
          (0): ConvBlock(
            (main): Conv3d(1, 16, kernel_size=(3, 3, 3), stride=(2, 2, 2), padding=(1, 1, 1))
            (activation): LeakyReLU(negative_slope=0.2)
          )
          (1): ConvBlock(
            (main): Conv3d(16, 32, kernel_size=(3, 3, 3), stride=(2, 2, 2), padding=(1, 1, 1))
            (activation): LeakyReLU(negative_slope=0.2)
          )
        )
        (uparm): ModuleList(
          (0): Sequential(
            (0): ConvBlock(
              (main): Conv3d(32, 32, kernel_size=(3, 3, 3), stride=(1, 1, 1), padding=(1, 1, 1))
              (activation): LeakyReLU(negative_slope=0.2)
            )
            (1): Upsample(scale_factor=2.0, mode=nearest)
          )
          (1): Sequential(
            (0): ConvBlock(
              (main): Conv3d(48, 32, kernel_size=(3, 3, 3), stride=(1, 1, 1), padding=(1, 1, 1))
              (activation): LeakyReLU(negative_slope=0.2)
            )
            (1): Upsample(scale_factor=2.0, mode=nearest)
          )
        )
        (extras): ModuleList(
          (0): ConvBlock(
            (main): Conv3d(33, 16, kernel_size=(3, 3, 3), stride=(1, 1, 1), padding=(1, 1, 1))
            (activation): LeakyReLU(negative_slope=0.2)
          )
          (1): ConvBlock(
            (main): Conv3d(16, 16, kernel_size=(3, 3, 3), stride=(1, 1, 1), padding=(1, 1, 1))
            (activation): LeakyReLU(negative_slope=0.2)
          )
        )
      )
      (flow): Conv3d(16, 3, kernel_size=(3, 3, 3), stride=(1, 1, 1), padding=(1, 1, 1))
      (deformer): DiffeoMeshDeformer(
        (integrate): IntegratePointWiseRK4(
          (interpolator): PointPooling()
        )
      )
    )
    (1): DeformationBlock(
      (encoder): Unet(
        (downarm): ModuleList(
          (0): ConvBlock(
            (main): Conv3d(4, 16, kernel_size=(3, 3, 3), stride=(2, 2, 2), padding=(1, 1, 1))
            (activation): LeakyReLU(negative_slope=0.2)
          )
          (1): ConvBlock(
            (main): Conv3d(16, 32, kernel_size=(3, 3, 3), stride=(2, 2, 2), padding=(1, 1, 1))
            (activation): LeakyReLU(negative_slope=0.2)
          )
        )
        (uparm): ModuleList(
          (0): Sequential(
            (0): ConvBlock(
              (main): Conv3d(32, 32, kernel_size=(3, 3, 3), stride=(1, 1, 1), padding=(1, 1, 1))
              (activation): LeakyReLU(negative_slope=0.2)
            )
            (1): Upsample(scale_factor=2.0, mode=nearest)
          )
          (1): Sequential(
            (0): ConvBlock(
              (main): Conv3d(48, 32, kernel_size=(3, 3, 3), stride=(1, 1, 1), padding=(1, 1, 1))
              (activation): LeakyReLU(negative_slope=0.2)
            )
            (1): Upsample(scale_factor=2.0, mode=nearest)
          )
        )
        (extras): ModuleList(
          (0): ConvBlock(
            (main): Conv3d(36, 16, kernel_size=(3, 3, 3), stride=(1, 1, 1), padding=(1, 1, 1))
            (activation): LeakyReLU(negative_slope=0.2)
          )
          (1): ConvBlock(
            (main): Conv3d(16, 16, kernel_size=(3, 3, 3), stride=(1, 1, 1), padding=(1, 1, 1))
            (activation): LeakyReLU(negative_slope=0.2)
          )
        )
      )
      (flow): Conv3d(16, 3, kernel_size=(3, 3, 3), stride=(1, 1, 1), padding=(1, 1, 1))
      (deformer): DiffeoMeshDeformer(
        (integrate): IntegratePointWiseRK4(
          (interpolator): PointPooling()
        )
      )
    )
    (2): DeformationBlock(
      (encoder): Unet(
        (downarm): ModuleList(
          (0): ConvBlock(
            (main): Conv3d(7, 16, kernel_size=(3, 3, 3), stride=(2, 2, 2), padding=(1, 1, 1))
            (activation): LeakyReLU(negative_slope=0.2)
          )
          (1): ConvBlock(
            (main): Conv3d(16, 32, kernel_size=(3, 3, 3), stride=(2, 2, 2), padding=(1, 1, 1))
            (activation): LeakyReLU(negative_slope=0.2)
          )
        )
        (uparm): ModuleList(
          (0): Sequential(
            (0): ConvBlock(
              (main): Conv3d(32, 32, kernel_size=(3, 3, 3), stride=(1, 1, 1), padding=(1, 1, 1))
              (activation): LeakyReLU(negative_slope=0.2)
            )
            (1): Upsample(scale_factor=2.0, mode=nearest)
          )
          (1): Sequential(
            (0): ConvBlock(
              (main): Conv3d(48, 32, kernel_size=(3, 3, 3), stride=(1, 1, 1), padding=(1, 1, 1))
              (activation): LeakyReLU(negative_slope=0.2)
            )
            (1): Upsample(scale_factor=2.0, mode=nearest)
          )
        )
        (extras): ModuleList(
          (0): ConvBlock(
            (main): Conv3d(39, 16, kernel_size=(3, 3, 3), stride=(1, 1, 1), padding=(1, 1, 1))
            (activation): LeakyReLU(negative_slope=0.2)
          )
          (1): ConvBlock(
            (main): Conv3d(16, 16, kernel_size=(3, 3, 3), stride=(1, 1, 1), padding=(1, 1, 1))
            (activation): LeakyReLU(negative_slope=0.2)
          )
        )
      )
      (flow): Conv3d(16, 3, kernel_size=(3, 3, 3), stride=(1, 1, 1), padding=(1, 1, 1))
      (deformer): DiffeoMeshDeformer(
        (integrate): IntegratePointWiseRK4(
          (interpolator): PointPooling()
        )
      )
    )
  )
)
[2023-03-10 18:30:59,695][__main__][INFO] - Pial model Total number of parameters: 325737
[2023-03-10 18:30:59,708][__main__][INFO] - Pial Model weights at deformation train 2 iteration 50000 and validation metric 0.0000 loaded from /corticalflow/resources/trained_models/CFPP_LEFT_PIAL.pth in 0.0129 secs
pial model size





model size: 1.243MB





0 - override config
Device 0: Tesla V100-SXM2-32GB, Memory : (99.21% free): 34359738368(total), 34089795584 (free), 269942784 (used)
Max Memory occupied by tensors: 0
Max Memory Cached: 0
Current Memory occupied by tensors: 0
Current Memory cached occupied by tensors: 0




0 - read MRI
Device 0: Tesla V100-SXM2-32GB, Memory : (99.20% free): 34359738368(total), 34085994496 (free), 273743872 (used)
Max Memory occupied by tensors: 0
Max Memory Cached: 0
Current Memory occupied by tensors: 0
Current Memory cached occupied by tensors: 0




0 - load template mesh
Device 0: Tesla V100-SXM2-32GB, Memory : (99.20% free): 34359738368(total), 34085994496 (free), 273743872 (used)
Max Memory occupied by tensors: 0
Max Memory Cached: 0
Current Memory occupied by tensors: 0
Current Memory cached occupied by tensors: 0




0 - setup white model
Device 0: Tesla V100-SXM2-32GB, Memory : (99.20% free): 34359738368(total), 34085994496 (free), 273743872 (used)
Max Memory occupied by tensors: 0
Max Memory Cached: 0
Current Memory occupied by tensors: 0
Current Memory cached occupied by tensors: 0




0 - print white model size
Device 0: Tesla V100-SXM2-32GB, Memory : (96.09% free): 34359738368(total), 33015398400 (free), 1344339968 (used)
Max Memory occupied by tensors: 5083136
Max Memory Cached: 6291456
Current Memory occupied by tensors: 2093056
Current Memory cached occupied by tensors: 6291456




0 - setup pial model
Device 0: Tesla V100-SXM2-32GB, Memory : (96.09% free): 34359738368(total), 33015398400 (free), 1344339968 (used)
Max Memory occupied by tensors: 5083136
Max Memory Cached: 6291456
Current Memory occupied by tensors: 2093056
Current Memory cached occupied by tensors: 6291456




0 - print print pial model size
Device 0: Tesla V100-SXM2-32GB, Memory : (96.09% free): 34359738368(total), 33015398400 (free), 1344339968 (used)
Max Memory occupied by tensors: 5619712
Max Memory Cached: 6291456
Current Memory occupied by tensors: 3407872
Current Memory cached occupied by tensors: 6291456




0 - End
Device 0: Tesla V100-SXM2-32GB, Memory : (96.09% free): 34359738368(total), 33015398400 (free), 1344339968 (used)
Max Memory occupied by tensors: 5619712
Max Memory Cached: 6291456
Current Memory occupied by tensors: 3407872
Current Memory cached occupied by tensors: 6291456




[2023-03-10 18:30:59,710][__main__][INFO] - predicting...

*********before white model() 
 
Device 0: Tesla V100-SXM2-32GB, Memory : (95.99% free): 34359738368(total), 32981843968 (free), 1377894400 (used)
Max Memory occupied by tensors: 29670400
Max Memory Cached: 39845888
Current Memory occupied by tensors: 29670400
Current Memory cached occupied by tensors: 39845888


*********emptying cache , before white model() 
 
Device 0: Tesla V100-SXM2-32GB, Memory : (96.00% free): 34359738368(total), 32983941120 (free), 1375797248 (used)
Max Memory occupied by tensors: 29670400
Max Memory Cached: 39845888
Current Memory occupied by tensors: 29670400
Current Memory cached occupied by tensors: 37748736


*********after white model()…. 
 
Device 0: Tesla V100-SXM2-32GB, Memory : (89.42% free): 34359738368(total), 30723211264 (free), 3636527104 (used)
Max Memory occupied by tensors: 1228008448
Max Memory Cached: 1925185536
Current Memory occupied by tensors: 62275072
Current Memory cached occupied by tensors: 1925185536


*********before pial model() 
 
Device 0: Tesla V100-SXM2-32GB, Memory : (89.42% free): 34359738368(total), 30723211264 (free), 3636527104 (used)
Max Memory occupied by tensors: 1228008448
Max Memory Cached: 1925185536
Current Memory occupied by tensors: 62275072
Current Memory cached occupied by tensors: 1925185536


*********emptying cache , before pial model() 
 
Device 0: Tesla V100-SXM2-32GB, Memory : (94.40% free): 34359738368(total), 32436584448 (free), 1923153920 (used)
Max Memory occupied by tensors: 1228008448
Max Memory Cached: 1925185536
Current Memory occupied by tensors: 62275072
Current Memory cached occupied by tensors: 211812352

Checked. Pial Model is not None. We have Pial Model.

*********after pial model() 
 
Device 0: Tesla V100-SXM2-32GB, Memory : (88.51% free): 34359738368(total), 30412832768 (free), 3946905600 (used)
Max Memory occupied by tensors: 1228008448
Max Memory Cached: 2235564032
Current Memory occupied by tensors: 81412096
Current Memory cached occupied by tensors: 2235564032

[2023-03-10 18:31:01,598][__main__][INFO] - 1.738558 total seconds for batch.
